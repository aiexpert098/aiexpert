<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© Ø¨Ø§Ù„ÙŠØ¯ - Three.js</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; }
        canvas { display: block; }
        #video-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 160px;
            height: 120px;
            z-index: 10;
            opacity: 0.7;
            border: 2px solid #00ffcc;
            border-radius: 10px;
            overflow: hidden;
            transform: scaleX(-1); /* Ù…Ø±Ø¢Ø© */
        }
        #video-element { width: 100%; height: 100%; object-fit: cover; }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            pointer-events: none;
            z-index: 20;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #00ffcc;
            direction: rtl;
        }
        h3 { margin: 0 0 10px 0; color: #00ffcc; }
        p { margin: 5px 0; font-size: 14px; }
        .highlight { color: #ff0055; font-weight: bold; }
    </style>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Three.js Ùˆ MediaPipe -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="ui">
        <h3>ğŸŒŒ Ø³Ø¯ÙŠÙ… Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ©</h3>
        <p>ğŸ– <b>Ø­Ø±Ùƒ ÙŠØ¯Ùƒ:</b> Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø³Ø§Ø¦Ù„ (ØªÙ†Ø§ÙØ±).</p>
        <p>ğŸ¤ <b>Ø§Ø¬Ù…Ø¹ Ø£ØµØ§Ø¨Ø¹Ùƒ (Pinch):</b> Ù„ØªÙØ¹ÙŠÙ„ <span class="highlight">Ø§Ù„Ø«Ù‚Ø¨ Ø§Ù„Ø£Ø³ÙˆØ¯</span> (Ø¬Ø°Ø¨).</p>
        <p>Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª ØªØªÙˆÙ‡Ø¬ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø³Ø±Ø¹ØªÙ‡Ø§ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©.</p>
    </div>

    <div id="video-container">
        <video id="video-element"></video>
    </div>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ù‡Ø¯ ---
    const PARTICLE_COUNT = 12000;
    const PARTICLE_SIZE = 0.2;
    const BOUNDS = 40; // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¹Ø§Ù„Ù…
    
    // --- THREE.JS SETUP ---
    const scene = new THREE.Scene();
    // Ø¶Ø¨Ø§Ø¨ Ø®ÙÙŠÙ Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø¹Ù…Ù‚
    scene.fog = new THREE.FogExp2(0x050505, 0.015);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 40;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠ ---
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(PARTICLE_COUNT * 3);
    const colors = new Float32Array(PARTICLE_COUNT * 3);
    
    // Ù…ØµÙÙˆÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ÙÙŠØ²ÙŠØ§Ø¡ (Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ)
    const velocities = new Float32Array(PARTICLE_COUNT * 3);
    const originalPositions = new Float32Array(PARTICLE_COUNT * 3);

    for (let i = 0; i < PARTICLE_COUNT; i++) {
        const x = (Math.random() - 0.5) * BOUNDS * 2;
        const y = (Math.random() - 0.5) * BOUNDS * 1.5;
        const z = (Math.random() - 0.5) * 10; // Ø·Ø¨Ù‚Ø© Ø±Ù‚ÙŠÙ‚Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹

        positions[i * 3] = x;
        positions[i * 3 + 1] = y;
        positions[i * 3 + 2] = z;

        originalPositions[i * 3] = x;
        originalPositions[i * 3 + 1] = y;
        originalPositions[i * 3 + 2] = z;

        velocities[i * 3] = 0;     // vx
        velocities[i * 3 + 1] = 0; // vy
        velocities[i * 3 + 2] = 0; // vz

        colors[i * 3] = 0;
        colors[i * 3 + 1] = 0.5;
        colors[i * 3 + 2] = 1;
    }

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

    // Ø®Ø§Ù…Ø© Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª (Ù…ØªÙˆÙ‡Ø¬Ø©)
    const material = new THREE.PointsMaterial({
        size: PARTICLE_SIZE,
        vertexColors: true,
        blending: THREE.AdditiveBlending,
        depthWrite: false,
        transparent: true,
        opacity: 0.9
    });

    const particles = new THREE.Points(geometry, material);
    scene.add(particles);

    // --- Ø­Ø§Ù„Ø© Ø§Ù„ÙŠØ¯ ---
    let handPos = { x: 0, y: 0, z: 0 };
    let isHandPresent = false;
    let isPinching = false;

    // --- MediaPipe Hand Tracking ---
    const videoElement = document.getElementById('video-element');
    
    function onResults(results) {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            isHandPresent = true;
            const landmarks = results.multiHandLandmarks[0];
            
            // ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© (Index Tip - 8)
            const indexTip = landmarks[8];
            const thumbTip = landmarks[4];

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù† 0..1 Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
            // Ù†Ù‚ÙˆÙ… Ø¨Ø¹ÙƒØ³ X Ù„Ø£Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ ÙƒÙ…Ø±Ø¢Ø©
            const targetX = (1 - indexTip.x) * 60 - 30; 
            const targetY = (1 - indexTip.y) * 40 - 20;
            
            // ØªÙ†Ø¹ÙŠÙ… Ø§Ù„Ø­Ø±ÙƒØ© (Lerp) Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²
            handPos.x += (targetX - handPos.x) * 0.15;
            handPos.y += (targetY - handPos.y) * 0.15;
            handPos.z = 0; // Ù†ÙØªØ±Ø¶ Ø§Ù„ÙŠØ¯ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„Ù‚Ø¨Ø¶ (Pinch)
            const d = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);
            isPinching = d < 0.05; // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø³Ø§ÙØ© Ø£Ù‚Ù„ Ù…Ù† 5%

        } else {
            isHandPresent = false;
            isPinching = false;
        }
    }

    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);

    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 640,
        height: 480
    });
    cameraUtils.start();

    // --- Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ­Ø±ÙŠÙƒ ÙˆØ§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ---
    const clock = new THREE.Clock();

    function animate() {
        requestAnimationFrame(animate);

        const dt = clock.getDelta(); // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚
        const posAttr = geometry.attributes.position;
        const colAttr = geometry.attributes.color;

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const ix = i * 3;
            const iy = i * 3 + 1;
            const iz = i * 3 + 2;

            let px = posAttr.array[ix];
            let py = posAttr.array[iy];
            let pz = posAttr.array[iz];

            let vx = velocities[ix];
            let vy = velocities[iy];
            let vz = velocities[iz];

            // 1. Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†Ø²Ù„ (Elasticity)
            // Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª ØªØ­Ø§ÙˆÙ„ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù…ÙƒØ§Ù†Ù‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø¨Ø·Ø¡
            const ox = originalPositions[ix];
            const oy = originalPositions[iy];
            const oz = originalPositions[iz];

            const homeForce = 0.015; // Ù‚ÙˆØ© "Ø§Ù„Ù†Ø§Ø¨Ø¶" Ù„Ù„Ø¹ÙˆØ¯Ø©
            vx += (ox - px) * homeForce;
            vy += (oy - py) * homeForce;
            vz += (oz - pz) * homeForce;

            // 2. Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ÙŠØ¯
            if (isHandPresent) {
                const dx = px - handPos.x;
                const dy = py - handPos.y;
                const dz = pz - handPos.z;
                
                const distSq = dx*dx + dy*dy + dz*dz;
                const dist = Math.sqrt(distSq);

                if (dist < 15) { // Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ù…Ø¹ÙŠÙ†
                    if (isPinching) {
                        // --- ÙˆØ¶Ø¹ Ø§Ù„Ø«Ù‚Ø¨ Ø§Ù„Ø£Ø³ÙˆØ¯ (Ø¬Ø§Ø°Ø¨ÙŠØ© Ù‚ÙˆÙŠØ©) ---
                        // Ù†Ø¬Ø°Ø¨ Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª Ø¨Ù‚ÙˆØ© Ù†Ø­Ùˆ Ø§Ù„ÙŠØ¯
                        const force = 80 / (distSq + 0.1); 
                        vx -= (dx / dist) * force;
                        vy -= (dy / dist) * force;
                        vz -= (dz / dist) * force;

                        // Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø§Ù† (Ø¯ÙˆØ§Ù…Ø©)
                        vx += -dz * 0.5;
                        vz += dx * 0.5;
                    } else {
                        // --- ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø§ÙØ± (Ø³Ø§Ø¦Ù„) ---
                        // Ù†Ø¯ÙØ¹ Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª Ø¨Ø¹ÙŠØ¯Ø§Ù‹
                        const force = 30 / (distSq + 1);
                        vx += (dx / dist) * force;
                        vy += (dy / dist) * force;
                        vz += (dz / dist) * force;
                    }
                }
            }

            // 3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡
            const friction = 0.94; // Ø§Ø­ØªÙƒØ§Ùƒ Ø§Ù„Ù‡ÙˆØ§Ø¡ Ù„ØªÙ‡Ø¯Ø¦Ø© Ø§Ù„Ø­Ø±ÙƒØ©
            vx *= friction;
            vy *= friction;
            vz *= friction;

            px += vx * dt * 10; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹
            py += vy * dt * 10;
            pz += vz * dt * 10;

            posAttr.array[ix] = px;
            posAttr.array[iy] = py;
            posAttr.array[iz] = pz;
            
            // Ø­ÙØ¸ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            velocities[ix] = vx;
            velocities[iy] = vy;
            velocities[iz] = vz;

            // 4. ØªÙ„ÙˆÙŠÙ† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø±Ø¹Ø©
            const speed = Math.sqrt(vx*vx + vy*vy + vz*vz);
            const t = Math.min(speed * 0.8, 1); // Ù‚ÙŠÙ…Ø© Ø¨ÙŠÙ† 0 Ùˆ 1

            // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¨Ø§Ø±Ø¯ (Ø£Ø²Ø±Ù‚/Ø³Ù…Ø§ÙˆÙŠ) Ù„Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨Ø·ÙŠØ¦Ø©
            const r1 = 0, g1 = 0.5, b1 = 1.0;
            // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø³Ø§Ø®Ù† (ÙˆØ±Ø¯ÙŠ/Ø£Ø¨ÙŠØ¶) Ù„Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ©
            const r2 = 1.0, g2 = 0.0, b2 = 0.5;

            // Ø®Ù„Ø· Ø§Ù„Ø£Ù„ÙˆØ§Ù†
            colAttr.array[ix] = r1 + (r2 - r1) * t;
            colAttr.array[iy] = g1 + (g2 - g1) * t;
            colAttr.array[iz] = b1 + (b2 - b1) * t;
        }

        posAttr.needsUpdate = true;
        colAttr.needsUpdate = true;

        // Ø¯ÙˆØ±Ø§Ù† Ø¨Ø·ÙŠØ¡ Ù„Ù„Ù…Ø´Ù‡Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        scene.rotation.y += 0.001;

        renderer.render(scene, camera);
    }

    animate();

    // Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>
</body>
</html>