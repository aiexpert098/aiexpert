<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Christmas Escape Room 3D</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; overflow: hidden; background-color: #1a202c; font-family: 'Lato', sans-serif; }
        .festive-font { font-family: 'Mountains of Christmas', cursive; }
        
        /* UI Overlays */
        #game-ui, #landing-screen, #win-screen, #lose-screen, #how-to-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Let clicks pass to canvas by default */
            z-index: 10;
        }
        
        /* Interactive elements need pointer-events auto */
        .interactive { pointer-events: auto; }
        
        /* Animations */
        @keyframes snow {
            0% { background-position: 0 0; }
            100% { background-position: 0 500px; }
        }
        
        .glow-text {
            text-shadow: 0 0 10px #f6e05e, 0 0 20px #d69e2e;
        }

        .fade-in { animation: fadeIn 1s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Loader */
        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #c53030;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- WebGL Container -->
    <div id="canvas-container" class="w-full h-full absolute top-0 left-0 z-0"></div>

    <!-- Landing Screen -->
    <div id="landing-screen" class="bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center text-white interactive z-50">
        <div class="text-center p-6 max-w-2xl">
            <h1 class="festive-font text-6xl md:text-8xl text-red-500 glow-text mb-4">Christmas Escape</h1>
            <p class="text-xl md:text-2xl text-green-400 mb-8 font-light">Solve the puzzles before midnight.</p>
            
            <button id="start-btn" class="bg-red-700 hover:bg-red-600 text-white font-bold py-4 px-10 rounded-full shadow-lg transform transition hover:scale-105 text-xl mb-4 border-2 border-gold-500">
                START GAME
            </button>
            <br>
            <button id="how-to-btn" class="text-gray-400 hover:text-white underline mt-2 text-sm">How to Play</button>
        </div>
        <div class="absolute bottom-5 text-gray-500 text-xs">
            WebGL Experience &bull; Sound On Recommended
        </div>
    </div>

    <!-- How To Play Modal -->
    <div id="how-to-modal" class="bg-black bg-opacity-80 flex items-center justify-center hidden interactive z-50">
        <div class="bg-gray-800 p-8 rounded-lg max-w-md border-2 border-green-600 text-white relative">
            <button id="close-howto" class="absolute top-2 right-4 text-2xl font-bold hover:text-red-500">&times;</button>
            <h2 class="festive-font text-3xl text-green-400 mb-4">How to Play</h2>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                <li>Look around by dragging the mouse (or finger).</li>
                <li>Click objects to interact (Stockings, Tree, Books, etc.).</li>
                <li>Find clues to solve 3 main puzzles.</li>
                <li>Combine the clues to unlock the door code.</li>
                <li>Escape before the timer runs out!</li>
            </ul>
        </div>
    </div>

    <!-- In-Game UI -->
    <div id="game-ui" class="hidden flex flex-col justify-between p-4">
        <!-- Top Bar -->
        <div class="flex justify-between items-start interactive">
            <div class="bg-gray-900 bg-opacity-70 p-2 rounded flex items-center gap-2 border border-gray-700">
                <span class="text-xl">ðŸŽ„</span>
                <button id="menu-btn" class="text-gray-300 hover:text-white text-sm font-bold">MENU</button>
            </div>
            
            <div class="flex flex-col items-end gap-2">
                <div class="bg-gray-900 bg-opacity-80 p-3 rounded-lg border border-red-900 shadow-lg">
                    <span id="timer" class="text-3xl font-mono text-red-500 font-bold">05:00</span>
                </div>
                <button id="sound-toggle" class="bg-gray-800 p-2 rounded-full text-white text-xs opacity-70 hover:opacity-100">ðŸ”Š On</button>
            </div>
        </div>

        <!-- Center Interaction Message (Hidden by default) -->
        <div id="interaction-message" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 text-white px-6 py-4 rounded-xl text-center pointer-events-none opacity-0 transition-opacity duration-300">
            <span id="msg-text" class="text-lg"></span>
        </div>

        <!-- Door Lock Overlay (Hidden by default) -->
        <div id="door-lock-overlay" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-800 p-6 rounded-lg border-4 border-yellow-700 shadow-2xl interactive hidden z-40 text-center">
            <h3 class="festive-font text-2xl text-gold-400 mb-4 text-yellow-500">Enter Passcode</h3>
            <div class="flex gap-2 justify-center mb-4">
                <input type="number" id="code-1" class="w-12 h-14 bg-gray-900 text-white text-center text-2xl border border-gray-600 rounded focus:border-yellow-500 outline-none" max="9" min="0">
                <input type="number" id="code-2" class="w-12 h-14 bg-gray-900 text-white text-center text-2xl border border-gray-600 rounded focus:border-yellow-500 outline-none" max="9" min="0">
                <input type="number" id="code-3" class="w-12 h-14 bg-gray-900 text-white text-center text-2xl border border-gray-600 rounded focus:border-yellow-500 outline-none" max="9" min="0">
            </div>
            <div class="flex justify-between gap-2">
                <button id="cancel-lock" class="bg-red-800 px-4 py-2 rounded text-white text-sm">Cancel</button>
                <button id="submit-lock" class="bg-green-700 px-4 py-2 rounded text-white font-bold text-sm">Unlock</button>
            </div>
        </div>

        <!-- Bottom Hint Area -->
        <div class="flex justify-center interactive mb-4">
            <div id="hint-box" class="bg-black bg-opacity-60 text-yellow-200 px-6 py-2 rounded-full text-sm md:text-base opacity-0 transition-opacity duration-300 font-medium">
                Hint: Look at the fireplace...
            </div>
        </div>
    </div>

    <!-- Win Screen -->
    <div id="win-screen" class="bg-green-900 bg-opacity-95 hidden flex-col items-center justify-center text-white interactive z-50">
        <h1 class="festive-font text-7xl text-yellow-400 mb-4 glow-text">Escaped!</h1>
        <p class="text-xl mb-6">You unlocked the cabin door.</p>
        <div class="text-2xl font-mono bg-green-800 px-6 py-2 rounded mb-8 border border-green-600">
            Time Remaining: <span id="final-time">00:00</span>
        </div>
        <button onclick="location.reload()" class="bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3 px-8 rounded shadow-lg">Play Again</button>
    </div>

    <!-- Lose Screen -->
    <div id="lose-screen" class="bg-gray-900 bg-opacity-95 hidden flex-col items-center justify-center text-white interactive z-50">
        <h1 class="festive-font text-7xl text-blue-300 mb-4">Time's Up</h1>
        <p class="text-xl mb-8">The magic of Christmas fades away...</p>
        <button onclick="location.reload()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded border border-gray-500">Try Again</button>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Init Firebase
        let auth, db, user;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            const initAuth = async () => {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            };
            initAuth();

            onAuthStateChanged(auth, (u) => {
                user = u;
                if(user) console.log("User authenticated:", user.uid);
            });

        } catch (e) {
            console.warn("Firebase failed to init (expected in some preview envs):", e);
        }

        // Expose DB function for game end
        window.logGameResult = async (result, timeLeft) => {
            if (!user || !db) return;
            try {
                // Rule 1: Strict Path
                const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'game_results');
                await addDoc(colRef, {
                    result: result,
                    timeLeft: timeLeft,
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Error logging result", e); }
        };
    </script>

    <!-- Game Logic -->
    <script>
        // --- Game State & Logic ---
        const gameState = {
            started: false,
            paused: false,
            timeLeft: 300,
            hintsFound: 0,
            puzzles: {
                stockings: { solved: false, sequence: [], correct: ['red', 'green', 'blue'] }, // Logic: "Gifts(Blue) first? No wait. Riddle: Bell(Green) thrice? No. Let's make it simple.
                // Riddle: "Bell(Green) rings thrice (ignore), Gifts(Blue) come first, then Stars(Red) that shine, then colors reversed."
                // "Gifts first" = Blue. "Stars next" = Red. "Colors reversed" -> The remaining is Green. 
                // Wait, "colors reversed" is tricky. Let's simplify for UX.
                // Riddle on note: "Blue as ice, Red as fire, Green as the pine." -> Click Blue, Red, Green.
                tree: { solved: false, currentPattern: [false, false, false, false, false], targetPattern: [true, false, true, false, true] },
                door: { solved: false, code: "741" } 
            }
        };

        // --- Three.js Globals ---
        let scene, camera, renderer, controls, raycaster, pointer;
        let interactables = []; // Objects the user can click
        let particleSystem;
        let clock = new THREE.Clock();

        // --- Audio Globals ---
        // Simple Audio Context wrapper
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = true;

        function playSound(type) {
            if (!soundEnabled || audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'click') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'success') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.linearRampToValueAtTime(1000, now + 0.1);
                osc.frequency.linearRampToValueAtTime(1500, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- Init Function ---
        function init() {
            // Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a0f0f); // Dark warm background
            scene.fog = new THREE.FogExp2(0x1a0f0f, 0.02);

            // Camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.6, 4); // Eye level, back of room

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 1;
            controls.maxDistance = 5;
            controls.maxPolarAngle = Math.PI / 1.5; // Don't look too far under floor
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambientLight);

            // Fireplace Light (Warm, flickering)
            const fireLight = new THREE.PointLight(0xffaa00, 1.5, 10);
            fireLight.position.set(0, 0.5, -4);
            fireLight.castShadow = true;
            fireLight.userData = { originalIntensity: 1.5 }; // For animation
            fireLight.name = "fireLight";
            scene.add(fireLight);

            // Window Light (Cold, Blue)
            const moonLight = new THREE.DirectionalLight(0x88ccff, 0.5);
            moonLight.position.set(-5, 3, -5);
            scene.add(moonLight);

            // Raycaster
            raycaster = new THREE.Raycaster();
            pointer = new THREE.Vector2();

            // Build Room
            buildRoom();
            buildDecorations();

            // Listeners
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('pointermove', onPointerMove);
            window.addEventListener('click', onClick);

            // Animation Loop
            animate();
        }

        // --- Object Building ---
        function buildRoom() {
            // Floor
            const floorGeo = new THREE.PlaneGeometry(10, 10);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x3e2723, roughness: 0.8 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Walls (Back, Left, Right) - Front is open for camera
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x5d4037, roughness: 0.9 });
            
            // Back Wall (Fireplace wall)
            const backWall = new THREE.Mesh(new THREE.BoxGeometry(10, 6, 0.2), wallMat);
            backWall.position.set(0, 3, -5);
            backWall.receiveShadow = true;
            scene.add(backWall);

            // Left Wall (Window)
            const leftWall = new THREE.Mesh(new THREE.BoxGeometry(0.2, 6, 10), wallMat);
            leftWall.position.set(-5, 3, 0);
            leftWall.receiveShadow = true;
            scene.add(leftWall);

            // Right Wall (Door)
            const rightWall = new THREE.Mesh(new THREE.BoxGeometry(0.2, 6, 10), wallMat);
            rightWall.position.set(5, 3, 0);
            rightWall.receiveShadow = true;
            scene.add(rightWall);

            // Ceiling
            const ceil = new THREE.Mesh(new THREE.PlaneGeometry(10, 10), new THREE.MeshStandardMaterial({ color: 0x2d1b15 }));
            ceil.position.set(0, 6, 0);
            ceil.rotation.x = Math.PI / 2;
            scene.add(ceil);
        }

        function buildDecorations() {
            // 1. Fireplace
            const fpGeo = new THREE.BoxGeometry(3, 2, 1);
            const fpMat = new THREE.MeshStandardMaterial({ color: 0x8d6e63 }); // Stone color
            const fireplace = new THREE.Mesh(fpGeo, fpMat);
            fireplace.position.set(0, 1, -4.5);
            fireplace.castShadow = true;
            fireplace.receiveShadow = true;
            scene.add(fireplace);

            // Fire Pit (Inside)
            const pitGeo = new THREE.BoxGeometry(2, 1.5, 0.5);
            const pitMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
            const pit = new THREE.Mesh(pitGeo, pitMat);
            pit.position.set(0, 0.8, -4.2);
            scene.add(pit);

            // Stockings (Red, Green, Blue)
            // Names: stocking_red, stocking_green, stocking_blue
            createStocking(0xff0000, -0.8, "stocking_red", "A bright red stocking.");
            createStocking(0x00ff00, 0, "stocking_green", "A festive green stocking.");
            createStocking(0x0000ff, 0.8, "stocking_blue", "A cool blue stocking.");

            // 2. Christmas Tree (Right Corner)
            const trunkGeo = new THREE.CylinderGeometry(0.2, 0.2, 1, 8);
            const trunkMat = new THREE.MeshStandardMaterial({ color: 0x3e2723 });
            const trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.position.set(3.5, 0.5, -3.5);
            scene.add(trunk);

            const treeLevels = 3;
            for(let i=0; i<treeLevels; i++) {
                const cone = new THREE.Mesh(
                    new THREE.ConeGeometry(1.5 - (i*0.4), 1.5, 16),
                    new THREE.MeshStandardMaterial({ color: 0x2e7d32 })
                );
                cone.position.set(3.5, 1.5 + (i*1), -3.5);
                cone.castShadow = true;
                scene.add(cone);
            }

            // Tree Lights (Interactable)
            // 5 Lights scattered
            createTreeLight(3.8, 1.5, -3.0, 0);
            createTreeLight(3.2, 1.8, -3.2, 1);
            createTreeLight(3.5, 2.2, -3.1, 2);
            createTreeLight(3.7, 2.5, -3.6, 3);
            createTreeLight(3.4, 2.8, -3.4, 4);

            // Drawer under tree (for code fragment)
            const drawerBox = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.4, 0.8), new THREE.MeshStandardMaterial({color: 0x5d4037}));
            drawerBox.position.set(3.5, 0.2, -3.5);
            drawerBox.name = "tree_drawer";
            drawerBox.userData = { hint: "A locked drawer under the tree.", type: 'drawer', locked: true };
            scene.add(drawerBox);
            interactables.push(drawerBox);

            // 3. Table & Cookies
            const tableGeo = new THREE.CylinderGeometry(1.5, 1.5, 0.1, 16);
            const tableMat = new THREE.MeshStandardMaterial({ color: 0x8d6e63 });
            const table = new THREE.Mesh(tableGeo, tableMat);
            table.position.set(-2, 1, 0);
            table.receiveShadow = true;
            scene.add(table);
            const leg = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1), new THREE.MeshStandardMaterial({color: 0x3e2723}));
            leg.position.set(-2, 0.5, 0);
            scene.add(leg);

            // Plate with Cookies
            const plate = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.05), new THREE.MeshStandardMaterial({color: 0xffffff}));
            plate.position.set(-2, 1.05, 0);
            scene.add(plate);

            // Visual representations of 2 Men, 4 Stars, 1 Cane
            // Just simple shapes
            const cookieMat = new THREE.MeshStandardMaterial({color: 0xd7ccc8}); // dough color
            // 2 Men (Box)
            const man1 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.02, 0.2), cookieMat); man1.position.set(-2.1, 1.08, 0.1); scene.add(man1);
            const man2 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.02, 0.2), cookieMat); man2.position.set(-2.2, 1.08, -0.1); scene.add(man2);
            // 4 Stars (Cylinder)
            for(let i=0; i<4; i++) {
                const s = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.02, 5), new THREE.MeshStandardMaterial({color: 0xffeb3b}));
                s.position.set(-1.8 + (i*0.1), 1.08, (i%2===0 ? 0.2 : -0.2));
                scene.add(s);
            }
            // 1 Cane (Red Box)
            const cane = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.02, 0.3), new THREE.MeshStandardMaterial({color: 0xff0000}));
            cane.position.set(-2, 1.08, 0);
            scene.add(cane);

            // Note on table
            const note = new THREE.Mesh(new THREE.PlaneGeometry(0.3, 0.4), new THREE.MeshBasicMaterial({color: 0xffffe0}));
            note.rotation.x = -Math.PI/2;
            note.position.set(-2, 1.06, 0.4);
            note.name = "table_note";
            note.userData = { hint: "A note about Santa's favorite numbers...", type: 'note', msg: "Santa loves: Gingerbread Men first, then Stars, then his Candy Cane." };
            scene.add(note);
            interactables.push(note);

            // 4. Door (Exit)
            const doorGeo = new THREE.BoxGeometry(0.2, 4, 2.5);
            const doorMat = new THREE.MeshStandardMaterial({ color: 0x4e342e });
            const door = new THREE.Mesh(doorGeo, doorMat);
            door.position.set(4.9, 2, 0);
            door.name = "exit_door";
            door.userData = { hint: "The way out. It's locked.", type: 'door' };
            scene.add(door);
            interactables.push(door);
            
            // Knob
            const knob = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshStandardMaterial({color: 0xffd700}));
            knob.position.set(4.8, 2, 0.8);
            scene.add(knob);

            // 5. Bookshelf (Left Wall)
            const shelf = new THREE.Mesh(new THREE.BoxGeometry(0.5, 3, 2), new THREE.MeshStandardMaterial({color: 0x3e2723}));
            shelf.position.set(-4.5, 1.5, -3);
            scene.add(shelf);
            
            // Books
            const bookColors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00];
            for(let i=0; i<5; i++) {
                const b = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.4, 0.1), new THREE.MeshStandardMaterial({color: bookColors[i%4]}));
                b.position.set(-4.3, 1.8, -3.5 + (i*0.2));
                scene.add(b);
            }
            
            // Clue Book (Interactive)
            const clueBook = new THREE.Mesh(new THREE.BoxGeometry(0.35, 0.45, 0.12), new THREE.MeshStandardMaterial({color: 0x9c27b0}));
            clueBook.position.set(-4.3, 1.8, -2.5);
            clueBook.name = "clue_book";
            clueBook.userData = { hint: "A strange purple book.", type: 'book_clue', msg: "The note reads: 'Blue as ice, Red as fire, Green as pine.'" };
            scene.add(clueBook);
            interactables.push(clueBook);

            // 6. Window Particles (Snow)
            const particlesGeo = new THREE.BufferGeometry();
            const count = 500;
            const positions = new Float32Array(count * 3);
            for(let i=0; i<count*3; i++) {
                positions[i] = (Math.random() - 0.5) * 10;
            }
            particlesGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const particlesMat = new THREE.PointsMaterial({color: 0xffffff, size: 0.05, transparent: true});
            particleSystem = new THREE.Points(particlesGeo, particlesMat);
            particleSystem.position.set(-6, 3, 0); // Outside window
            scene.add(particleSystem);
        }

        function createStocking(color, xOffset, name, hint) {
            const mat = new THREE.MeshStandardMaterial({ color: color });
            const sockTop = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.6, 0.1), mat);
            sockTop.position.set(xOffset, 2.2, -3.9);
            sockTop.name = name;
            sockTop.userData = { hint: hint, type: 'stocking', colorId: name.split('_')[1] };
            
            const sockFoot = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.2, 0.1), mat);
            sockFoot.position.set(0.1, -0.2, 0);
            sockTop.add(sockFoot);

            scene.add(sockTop);
            interactables.push(sockTop);
        }

        function createTreeLight(x, y, z, index) {
            const geo = new THREE.SphereGeometry(0.1);
            const mat = new THREE.MeshStandardMaterial({ color: 0x222222, emissive: 0x000000 });
            const bulb = new THREE.Mesh(geo, mat);
            bulb.position.set(x, y, z);
            bulb.name = `light_${index}`;
            bulb.userData = { hint: "A toggleable light bulb.", type: 'light', index: index, active: false };
            scene.add(bulb);
            interactables.push(bulb);
        }

        // --- Interaction Logic ---
        function onPointerMove( event ) {
            pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
            pointer.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
        }

        function onClick(event) {
            if(!gameState.started || gameState.paused) return;

            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(interactables, false); // No recursive for simplicity, ensure parent is interactive

            if (intersects.length > 0) {
                const obj = intersects[0].object;
                handleInteraction(obj);
            }
        }

        function handleInteraction(obj) {
            const data = obj.userData;
            playSound('click');

            // Show simple feedback msg
            showFeedback(data.hint);

            // Puzzle Logic
            if(data.type === 'stocking') {
                // Wigle effect
                const originalY = obj.position.y;
                obj.position.y += 0.1;
                setTimeout(() => obj.position.y = originalY, 200);

                if(!gameState.puzzles.stockings.solved) {
                    gameState.puzzles.stockings.sequence.push(data.colorId);
                    checkStockingSequence();
                }
            }
            else if(data.type === 'light') {
                // Toggle Light
                data.active = !data.active;
                obj.material.emissive.setHex(data.active ? 0xffff00 : 0x000000);
                
                // Update pattern
                gameState.puzzles.tree.currentPattern[data.index] = data.active;
                checkTreePattern();
            }
            else if(data.type === 'note') {
                showModal("Note Found", data.msg); // Cookie clue
            }
            else if(data.type === 'book_clue') {
                showModal("Old Book", data.msg); // Stocking clue
            }
            else if(data.type === 'tree_drawer') {
                if(data.locked) {
                    showFeedback("It's locked. The lights on the tree seem connected.");
                } else {
                    showModal("Drawer Opened", "Inside is a wooden block with the number '4' carved into it.");
                }
            }
            else if(data.type === 'door') {
                document.getElementById('door-lock-overlay').classList.remove('hidden');
                gameState.paused = true;
            }
        }

        // --- Puzzle Checking ---
        function checkStockingSequence() {
            const current = gameState.puzzles.stockings.sequence;
            const target = gameState.puzzles.stockings.correct; // blue, red, green

            // Note on wall says: "Blue as ice, Red as fire, Green as pine."
            // Target: Blue, Red, Green
            const required = ['blue', 'red', 'green'];

            if(current.length === 3) {
                if(JSON.stringify(current) === JSON.stringify(required)) {
                    gameState.puzzles.stockings.solved = true;
                    playSound('success');
                    showModal("Success!", "A distinct clicking sound comes from the fireplace. You find a metal '7' in the ashes.");
                } else {
                    playSound('error');
                    gameState.puzzles.stockings.sequence = []; // Reset
                    showFeedback("That didn't feel right. Sequence reset.");
                }
            }
        }

        function checkTreePattern() {
            const current = gameState.puzzles.tree.currentPattern;
            const target = [true, false, true, false, true]; // On, Off, On, Off, On
            
            if(JSON.stringify(current) === JSON.stringify(target)) {
                if(!gameState.puzzles.tree.solved) {
                    gameState.puzzles.tree.solved = true;
                    // Unlock drawer
                    const drawer = scene.getObjectByName('tree_drawer');
                    drawer.userData.locked = false;
                    drawer.userData.hint = "The drawer is unlocked!";
                    playSound('success');
                    showFeedback("You hear a latch click under the tree.");
                }
            }
        }

        // --- UI Functions ---
        function showFeedback(text) {
            const el = document.getElementById('hint-box');
            el.innerText = text;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 3000);
        }

        function showModal(title, text) {
            const el = document.getElementById('interaction-message');
            document.getElementById('msg-text').innerHTML = `<strong class="text-yellow-400 block mb-1">${title}</strong>${text}`;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 4000);
        }

        // --- Door Lock Logic ---
        document.getElementById('cancel-lock').addEventListener('click', () => {
            document.getElementById('door-lock-overlay').classList.add('hidden');
            gameState.paused = false;
        });

        document.getElementById('submit-lock').addEventListener('click', () => {
            const c1 = document.getElementById('code-1').value;
            const c2 = document.getElementById('code-2').value;
            const c3 = document.getElementById('code-3').value;
            const input = `${c1}${c2}${c3}`;

            if(input === gameState.puzzles.door.code) {
                // WIN
                document.getElementById('door-lock-overlay').classList.add('hidden');
                playSound('success');
                winGame();
            } else {
                playSound('error');
                showFeedback("Wrong Code.");
            }
        });

        // --- Game Flow ---
        function startGame() {
            document.getElementById('landing-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            gameState.started = true;
            init();
            
            // Start Timer
            const timerEl = document.getElementById('timer');
            const interval = setInterval(() => {
                if(gameState.paused) return;
                gameState.timeLeft--;
                
                const m = Math.floor(gameState.timeLeft / 60).toString().padStart(2, '0');
                const s = (gameState.timeLeft % 60).toString().padStart(2, '0');
                timerEl.innerText = `${m}:${s}`;

                if(gameState.timeLeft <= 0) {
                    clearInterval(interval);
                    loseGame();
                }
            }, 1000);
        }

        function winGame() {
            gameState.paused = true;
            const timeSpent = 300 - gameState.timeLeft;
            const m = Math.floor(timeSpent / 60);
            const s = timeSpent % 60;
            document.getElementById('final-time').innerText = `${m}m ${s}s`;
            
            // Open door animation (simple rotation)
            const door = scene.getObjectByName('exit_door');
            door.rotation.y = -Math.PI / 2;
            
            setTimeout(() => {
                document.getElementById('win-screen').style.display = 'flex';
                if(window.logGameResult) window.logGameResult("WIN", gameState.timeLeft);
            }, 1000);
        }

        function loseGame() {
            gameState.paused = true;
            document.getElementById('lose-screen').style.display = 'flex';
            if(window.logGameResult) window.logGameResult("LOSE", 0);
        }

        // --- Event Listeners UI ---
        document.getElementById('start-btn').addEventListener('click', startGame);
        
        document.getElementById('how-to-btn').addEventListener('click', () => {
            document.getElementById('how-to-modal').classList.remove('hidden');
        });
        document.getElementById('close-howto').addEventListener('click', () => {
            document.getElementById('how-to-modal').classList.add('hidden');
        });
        
        document.getElementById('sound-toggle').addEventListener('click', (e) => {
            soundEnabled = !soundEnabled;
            e.target.innerText = soundEnabled ? "ðŸ”Š On" : "ðŸ”‡ Off";
        });

        // --- Three.js Animation ---
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            const delta = clock.getDelta();
            const now = clock.getElapsedTime();

            if (gameState.started && !gameState.paused) {
                controls.update();
                
                // Flicker Fire
                const fire = scene.getObjectByName('fireLight');
                if(fire) {
                    fire.intensity = fire.userData.originalIntensity + (Math.random() * 0.4 - 0.2);
                }

                // Snow
                if(particleSystem) {
                    particleSystem.rotation.y = now * 0.05;
                }
                
                // Raycaster hover effect
                raycaster.setFromCamera(pointer, camera);
                const intersects = raycaster.intersectObjects(interactables, false);
                
                // Reset standard cursor
                document.body.style.cursor = 'default';
                
                if (intersects.length > 0) {
                    document.body.style.cursor = 'pointer';
                    const obj = intersects[0].object;
                    // Optional: Highlight material
                }

                renderer.render(scene, camera);
            }
        }

    </script>
</body>
</html>