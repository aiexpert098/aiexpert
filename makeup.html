<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Beauty Effect Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/r165/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #1a1a2e; }
        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        canvas { display: block; }
        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            outline: none;
            transition: background .2s;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #E685A6;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        #info {
            position: absolute; top: 10px; left: 10px; padding: 8px; background: rgba(0,0,0,0.5); color: white; border-radius: 8px;
            font-size: 0.8rem;
        }
        /* Simulated Camera Feed (Black for simplicity, but a video stream would be here) */
        #video-feed {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #111; /* Simulates the camera background */
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <div id="video-feed"></div>
    </div>
    <div id="info">
        
        <p>AR Makeup Effect Simulation. Face tracking is simulated by the floating mesh.</p>
    </div>
    
    <div id="controls">
        <h3 class="text-lg font-bold text-[#E685A6] mb-3">Makeup Intensity Controls</h3>
        <div class="control-group">
            <label for="lipIntensity">Glossy Pink Lips Intensity</label>
            <input type="range" id="lipIntensity" min="0" max="1" step="0.01" value="0.7">
        </div>
        <div class="control-group">
            <label for="eyeShadowStrength">Eyeshadow Gradient Strength</label>
            <input type="range" id="eyeShadowStrength" min="0" max="1" step="0.01" value="0.8">
        </div>
        <div class="control-group">
            <label for="skinSmoothing">Skin Texture Smoothing</label>
            <input type="range" id="skinSmoothing" min="0" max="1" step="0.01" value="0.5">
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // --- Configuration & Colors ---
        const CONFIG = {
            // Specified Colors (Hex to Normalized RGB)
            foundationColor: new THREE.Color(0xd2b48c).multiplyScalar(0.9), // Soft neutral beige (using tan as close sim)
            blushColor: new THREE.Color(0xF4A996), // Soft peach
            lipColor: new THREE.Color(0xE685A6), // Glossy pink
            eyeshadowStart: new THREE.Color(0xC6A27E), // Warm beige
            eyeshadowEnd: new THREE.Color(0x8B6238), // Light brown
            highlightColor: new THREE.Color(0xFFF1D9), // Subtle cheekbone highlight
        };

        let camera, scene, renderer, faceMesh;
        let uniformSmoothing, uniformLipIntensity, uniformEyeShadowStrength;
        
        // --- Shaders for Realistic Makeup Application ---
        
        // Vertex Shader: Standard position mapping
        const vertexShader = `
            varying vec2 vUv;
            varying vec3 vNormal;
            varying vec3 vPosition;
            void main() {
                vUv = uv;
                vNormal = normalize(normalMatrix * normal);
                vPosition = (modelViewMatrix * vec4(position, 1.0)).xyz;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        `;

        // Fragment Shader: Applies all makeup layers dynamically
        const fragmentShader = `
            uniform float time;
            uniform float skinSmoothing;
            uniform float lipIntensity;
            uniform float eyeShadowStrength;

            uniform vec3 foundationColor;
            uniform vec3 blushColor;
            uniform vec3 lipColor;
            uniform vec3 eyeshadowStart;
            uniform vec3 eyeshadowEnd;
            uniform vec3 highlightColor;

            varying vec2 vUv;
            varying vec3 vNormal;
            varying vec3 vPosition;

            // Simple function to simulate lighting and normal influence
            float getLighting() {
                // Simulates dynamic lighting adaptation
                return max(0.0, dot(vNormal, normalize(vec3(sin(time), 1.0, cos(time)))));
            }
            
            // Function to blend colors realistically based on normal/light
            vec3 applyColor(vec3 base, vec3 color, float intensity) {
                float light = getLighting();
                vec3 finalColor = mix(base, color, intensity);
                
                // Add subtle shading and highlight based on position/normal (occlusion/depth simulation)
                float normalInfluence = max(0.0, dot(vNormal, normalize(vec3(0.0, 0.0, 1.0))));
                finalColor *= (0.8 + light * 0.2); // Simple dynamic brightness
                finalColor = mix(finalColor, base, smoothstep(0.0, 0.3, length(vNormal))); // Occlusion blend
                
                return finalColor;
            }

            void main() {
                // Base skin color (simulated) - should include texture data in a real AR app
                vec3 baseColor = foundationColor;
                
                // --- 1. Foundation and Skin Smoothing ---
                // The base color is the foundation. We use skinSmoothing to simulate blurring fine detail.
                float smoothMix = skinSmoothing * 0.4;
                baseColor = mix(baseColor, foundationColor, smoothMix); 
                
                // --- 2. Lip Application (Glossy Pink) ---
                // Define lip area using UV coordinates (simulated landmarks)
                float lipMask = smoothstep(0.3, 0.4, vUv.y) - smoothstep(0.5, 0.6, vUv.y);
                lipMask *= (1.0 - smoothstep(0.0, 0.1, abs(vUv.x - 0.5) * 2.0));
                
                vec3 appliedLipColor = applyColor(baseColor, lipColor, lipIntensity);
                baseColor = mix(baseColor, appliedLipColor, lipMask * lipIntensity);
                
                // Add Gloss (simulated specular highlight)
                if (lipMask > 0.1) {
                    float specular = pow(max(0.0, dot(vNormal, normalize(vec3(0.0, 0.5, 1.0)))), 30.0);
                    baseColor += highlightColor * specular * 0.5 * lipIntensity;
                }

                // --- 3. Eyeshadow Gradient (Warm Beige to Light Brown) ---
                // Define eye area using UV coordinates
                float eyeMask = 0.0;
                eyeMask += smoothstep(0.8, 0.9, vUv.y); // Top of the mesh
                eyeMask *= (1.0 - smoothstep(0.0, 0.1, abs(vUv.x - 0.5) * 2.0)); // Center area
                
                // Create gradient based on UV Y (vertical position)
                vec3 gradientColor = mix(eyeshadowStart, eyeshadowEnd, vUv.y * 2.0 - 1.0);
                
                vec3 appliedEyeColor = applyColor(baseColor, gradientColor, eyeShadowStrength * 0.8);
                baseColor = mix(baseColor, appliedEyeColor, eyeMask * eyeShadowStrength);

                // --- 4. Blush and Highlight ---
                // Define cheekbone area (simulated landmarks)
                float cheekMask = 0.0;
                cheekMask += smoothstep(0.5, 0.6, vUv.y) * (1.0 - smoothstep(0.2, 0.4, abs(vUv.x - 0.5) * 2.0));
                
                vec3 appliedBlushColor = applyColor(baseColor, blushColor, 0.6); // Fixed intensity for blush
                baseColor = mix(baseColor, appliedBlushColor, cheekMask * 0.3);

                // Subtle Cheekbone Highlight
                float highlightMask = smoothstep(0.55, 0.65, vUv.y) * smoothstep(0.1, 0.2, abs(vUv.x - 0.5) * 2.0);
                float specularHighlight = pow(max(0.0, dot(vNormal, normalize(vec3(0.5, 0.5, 1.0)))), 50.0);
                baseColor += highlightColor * specularHighlight * highlightMask * 0.5;

                // --- 5. Eyeliner and Brows (Visual only, simple UV line) ---
                // Ultra-thin black eyeliner simulation
                float eyeliner = 1.0 - smoothstep(0.88, 0.9, vUv.y) * smoothstep(0.0, 0.01, abs(vUv.x - 0.5));
                baseColor = mix(baseColor, vec3(0.0, 0.0, 0.0), eyeliner * 0.5);

                gl_FragColor = vec4(baseColor, 1.0);
            }
        `;

        /**
         * Initializes the Three.js scene and components.
         */
        function init() {
            // Setup Scene and Camera (Simulated AR View)
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 2;

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0); // Transparent to show the simulated video feed
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // --- Makeup Mesh (Placeholder for Face Mesh Tracking Data) ---
            
            // We use a complex, rounded geometry to simulate the face surface and UV map
            const geometry = new THREE.SphereGeometry(1.5, 64, 64);
            
            // Initialize Uniforms
            uniformLipIntensity = { value: 0.7 };
            uniformEyeShadowStrength = { value: 0.8 };
            uniformSmoothing = { value: 0.5 };

            const makeupMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    time: { value: 0.0 },
                    skinSmoothing: uniformSmoothing,
                    lipIntensity: uniformLipIntensity,
                    eyeShadowStrength: uniformEyeShadowStrength,
                    foundationColor: { value: CONFIG.foundationColor },
                    blushColor: { value: CONFIG.blushColor },
                    lipColor: { value: CONFIG.lipColor },
                    eyeshadowStart: { value: CONFIG.eyeshadowStart },
                    eyeshadowEnd: { value: CONFIG.eyeshadowEnd },
                    highlightColor: { value: CONFIG.highlightColor },
                },
                vertexShader: vertexShader,
                fragmentShader: fragmentShader,
                // Ensure depth testing and writing are set correctly for "occlusion handling" simulation
                transparent: true,
                depthWrite: true
            });

            faceMesh = new THREE.Mesh(geometry, makeupMaterial);
            scene.add(faceMesh);
            
            // --- Lighting Simulation (Dynamic Lighting Adaptation) ---
            const light = new THREE.DirectionalLight(0xffffff, 2);
            light.position.set(0, 0, 10);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));

            // --- UI Listeners ---
            document.getElementById('lipIntensity').addEventListener('input', (event) => {
                uniformLipIntensity.value = parseFloat(event.target.value);
            });
            document.getElementById('eyeShadowStrength').addEventListener('input', (event) => {
                uniformEyeShadowStrength.value = parseFloat(event.target.value);
            });
            document.getElementById('skinSmoothing').addEventListener('input', (event) => {
                uniformSmoothing.value = parseFloat(event.target.value);
            });

            window.addEventListener('resize', onWindowResize);
            renderer.setAnimationLoop(animate);
        }

        /**
         * Handles window resize.
         */
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        /**
         * Main animation loop.
         * Simulates face tracking movement and dynamic lighting changes.
         */
        function animate(time) {
            // Update time uniform for dynamic effects (pulsing, light changes)
            faceMesh.material.uniforms.time.value = time * 0.001;
            
            // Simulate subtle face movement (Advanced Face Mesh Tracking)
            faceMesh.rotation.y = Math.sin(time * 0.0005) * 0.1;
            faceMesh.rotation.x = Math.cos(time * 0.0003) * 0.05;

            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
